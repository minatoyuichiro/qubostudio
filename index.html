<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>QUBO Studio - Wide Editor</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .font-mono { font-family: 'Fira Code', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-50 p-4 flex flex-col gap-4">

    <header class="flex justify-between items-center bg-white px-6 py-3 rounded-2xl border border-slate-200 shadow-sm shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-black text-sm shadow-blue-200 shadow-lg">Q</div>
            <h1 class="font-extrabold text-slate-800 tracking-tight">QUBO <span class="text-blue-600">Studio</span></h1>
        </div>
        
        <div class="flex items-center gap-6">
            <div id="status-group" class="flex flex-col items-end">
                <span id="py-status" class="text-[10px] font-bold text-orange-400 uppercase tracking-widest leading-none">Pyodide: Initializing</span>
                <div class="w-32 h-1 bg-slate-100 rounded-full mt-1.5 overflow-hidden">
                    <div id="progress-bar" class="w-0 h-full bg-blue-500 transition-all duration-100"></div>
                </div>
            </div>
            <button id="run-btn" onclick="compileAndSolve()" disabled 
                class="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-200 text-white px-8 py-2.5 rounded-xl font-bold transition-all shadow-md active:scale-95 text-xs">
                実行
            </button>
        </div>
    </header>

    <div class="flex-1 flex gap-4 min-h-0">
        
        <section class="flex-[3] flex flex-col bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="bg-slate-50/50 px-5 py-2.5 border-b border-slate-200 flex justify-between items-center shrink-0">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Formulation (SymPy)</span>
                <span class="text-[10px] text-blue-500 font-mono">index.py</span>
            </div>
            <textarea id="python-input" class="w-full flex-1 p-6 text-slate-700 font-mono text-sm outline-none resize-none leading-relaxed custom-scrollbar" spellcheck="false">
import sympy as sp
import json

# 1. 変数の定義
n = 10
x = sp.symbols(f'x0:{n}')

# 2. ハミルトニアンの記述
# 例：変数全体の合計が 3 になるようにする
H = (sum(x) - 3)**2

# 3. QUBOへの自動変換
expr = sp.expand(H)
qubo_dict = {}

for term in expr.as_ordered_terms():
    coeff, monom = term.as_coeff_Mul()
    vars = list(monom.free_symbols)
    v_indices = sorted([int(v.name[1:]) for v in vars])
    
    if len(v_indices) == 1:
        key = f"{v_indices[0]},{v_indices[0]}"
        qubo_dict[key] = qubo_dict.get(key, 0) + float(coeff)
    elif len(v_indices) == 2:
        key = f"{v_indices[0]},{v_indices[1]}"
        qubo_dict[key] = qubo_dict.get(key, 0) + float(coeff)

json.dumps(qubo_dict)
            </textarea>
        </section>

        <aside class="flex-1 flex flex-col bg-slate-900 rounded-2xl shadow-xl overflow-hidden min-w-[320px]">
            <div class="bg-slate-800 px-5 py-3 border-b border-slate-700 flex justify-between items-center shrink-0">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Console</span>
                <span id="kT-display" class="text-[10px] font-mono text-blue-400">WAITING</span>
            </div>
            <div id="output" class="flex-1 p-5 font-mono text-[11px] text-blue-200 overflow-auto custom-scrollbar leading-relaxed">
                Pythonエンジンを起動中...
            </div>
        </aside>

    </div>

    <script>
        // --- Bqubo クラス ---
        class Bqubo {
            constructor(qubo, params = {}) {
                this.qubo = qubo;
                this.params = {
                    kTinit: parseFloat(params.kTinit) || 10.0,
                    cl: parseFloat(params.cl) || 0.992,
                    kTF: parseFloat(params.kTF) || 0.01,
                    rpt: parseInt(params.rpt) || 1500 
                };
            }
            async solve(onStep) {
                const workerCode = `
                    self.onmessage = function(e) {
                        const { n, linear, adjTo, adjWeight, adjCount, offsets, kTinit, cl, kTF, rpt } = e.data;
                        const state = new Uint8Array(n);
                        for(let i=0; i<n; i++) state[i] = Math.random() > 0.5 ? 1 : 0;
                        let kT = kTinit;
                        while(kT > kTF) {
                            for (let r = 0; r < rpt; r++) {
                                const i = (Math.random() * n) | 0;
                                let localField = linear[i];
                                const start = offsets[i];
                                const count = adjCount[i];
                                for (let k = 0; k < count; k++) {
                                    const idx = start + k;
                                    if (state[adjTo[idx]] === 1) localField += adjWeight[idx];
                                }
                                const deltaE = (state[i] === 0) ? localField : -localField;
                                if (deltaE <= 0 || Math.random() < Math.exp(-deltaE / kT)) state[i] ^= 1;
                            }
                            kT *= cl;
                            self.postMessage({ state, kT, finished: false });
                        }
                        self.postMessage({ state, kT, finished: true });
                    };
                `;
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                const worker = new Worker(URL.createObjectURL(blob));
                const rawNodes = Array.from(new Set(Object.keys(this.qubo).flatMap(k => k.split(',').map(Number)))).sort((a,b)=>a-b);
                const map = new Map(rawNodes.map((n, i) => [n, i]));
                const N = rawNodes.length;
                const linear = new Float64Array(N), tempAdj = Array.from({ length: N }, () => []);
                let totalEdges = 0;
                for (let key in this.qubo) {
                    const parts = key.split(',').map(Number);
                    const w = this.qubo[key], i = map.get(parts[0]);
                    if (parts.length === 1 || parts[0] === parts[1]) { linear[i] += w; } 
                    else {
                        const j = map.get(parts[1]);
                        tempAdj[i].push({to: j, w: w}); tempAdj[j].push({to: i, w: w});
                        totalEdges += 2;
                    }
                }
                const adjTo = new Int32Array(totalEdges), adjWeight = new Float64Array(totalEdges), adjCount = new Int32Array(N), offsets = new Int32Array(N);
                let currentPos = 0;
                for (let i = 0; i < N; i++) {
                    offsets[i] = currentPos; adjCount[i] = tempAdj[i].length;
                    for (let edge of tempAdj[i]) { adjTo[currentPos] = edge.to; adjWeight[currentPos] = edge.w; currentPos++; }
                }
                return new Promise((resolve) => {
                    worker.postMessage({ n: N, linear, adjTo, adjWeight, adjCount, offsets, ...this.params }, [linear.buffer, adjTo.buffer, adjWeight.buffer, adjCount.buffer, offsets.buffer]);
                    worker.onmessage = (e) => {
                        const { state, kT, finished } = e.data;
                        const readableState = {};
                        rawNodes.forEach((node, idx) => readableState[node] = state[idx]);
                        if (onStep) onStep(readableState, kT);
                        if (finished) { worker.terminate(); URL.revokeObjectURL(blob); resolve(readableState); }
                    };
                });
            }
        }

        // --- Logic Bridge ---
        let pyodide;
        async function init() {
            const out = document.getElementById('output');
            const status = document.getElementById('py-status');
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage("sympy");
                status.innerText = "Pyodide: Ready";
                status.classList.replace("text-orange-400", "text-green-500");
                out.innerText = ">>> System ready.\n>>> Write your Hamiltonian in Python.";
                document.getElementById('run-btn').disabled = false;
            } catch (e) { out.innerText = "Init Error: " + e; }
        }

        async function compileAndSolve() {
            const pyCode = document.getElementById('python-input').value;
            const out = document.getElementById('output');
            const prog = document.getElementById('progress-bar');
            const kTDisp = document.getElementById('kT-display');
            
            out.innerText = ">>> Compiling SymPy formulation...";
            prog.style.width = "0%";

            try {
                const jsonStr = await pyodide.runPythonAsync(pyCode);
                const quboData = JSON.parse(jsonStr);
                
                out.innerText += "\n>>> Compilation Success.\n>>> Variables: " + Object.keys(quboData).length;
                out.innerText += "\n>>> Running Bqubo.js Solver...";

                const solver = new Bqubo(quboData, { kTinit: 10.0, cl: 0.995 });
                const result = await solver.solve((state, kT) => {
                    const p = (1 - (kT / 10.0)) * 100;
                    prog.style.width = `${p}%`;
                    kTDisp.innerText = `TEMP: ${kT.toFixed(3)}`;
                });

                out.innerText += "\n\n[FINAL RESULT]\n" + JSON.stringify(result, null, 2);
                prog.style.width = "100%";
                kTDisp.innerText = "FINISHED";
            } catch (e) { out.innerText += "\n\nERROR:\n" + e; }
        }

        init();
    </script>
</body>
</html>